{% extends "layouts/base.html" %}

{% block title %}Tenant Management{% endblock %}

{% block content %}
<div x-data="{
    tenants: [],
    loading: true,
    error: null,
    isAuthenticated: false,
    async checkAuth() {
        try {
            const response = await fetch('/admin/auth/me', {
                credentials: 'same-origin'
            });
            if (response.ok) {
                this.isAuthenticated = true;
                return true;
            } else {
                this.isAuthenticated = false;
                return false;
            }
        } catch (err) {
            this.isAuthenticated = false;
            return false;
        }
    },
    async loadTenants() {
        // Check auth first
        const isAuth = await this.checkAuth();
        if (!isAuth) {
            this.loading = false;
            window.location.href = '/admin/login';
            return;
        }

        try {
            const response = await fetch('/admin/tenants/data', {
                credentials: 'same-origin'
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    this.tenants = data.tenants;
                } else {
                    this.error = data.error || 'Failed to load tenant';
                }
            } else if (response.status === 401) {
                window.location.href = '/admin/login';
            } else {
                this.error = 'Failed to load tenant';
            }
        } catch (err) {
            this.error = 'Connection error. Please try again.';
        } finally {
            this.loading = false;
        }
    }
}" x-init="loadTenants()">

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold">Tenant Management</h1>
        <p class="text-base-content/70 mt-2">View and manage tenant configuration</p>
    </div>

    <!-- Not Authenticated State -->
    <div x-show="!isAuthenticated" x-cloak class="alert alert-warning">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
        <span>Please login to view tenant information</span>
    </div>

    <!-- Loading State -->
    <div x-show="loading && isAuthenticated" class="flex justify-center items-center min-h-[400px]">
        <span class="loading loading-spinner loading-lg"></span>
    </div>

    <!-- Error State -->
    <div x-show="error && isAuthenticated" x-cloak class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span x-text="error"></span>
    </div>

    <!-- Tenant Info Card -->
    <template x-if="!loading && !error && isAuthenticated && tenants.length > 0">
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <template x-for="tenant in tenants" :key="tenant.id">
                    <div>
                        <h2 class="card-title text-2xl mb-4" x-text="tenant.name"></h2>

                        <!-- Basic Info -->
                        <div>
                            <h3 class="font-semibold text-lg mb-3">Basic Information</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-sm text-base-content/70">Tenant ID</label>
                                    <div class="font-mono text-sm bg-base-200 p-2 rounded" x-text="tenant.id"></div>
                                </div>
                                <div>
                                    <label class="text-sm text-base-content/70">Company Name</label>
                                    <div class="text-lg" x-text="tenant.name"></div>
                                </div>
                                <div>
                                    <label class="text-sm text-base-content/70">Timezone</label>
                                    <div x-text="tenant.timezone || 'Australia/Sydney'"></div>
                                </div>
                                <div>
                                    <label class="text-sm text-base-content/70">Created</label>
                                    <div x-text="new Date(tenant.created_at).toLocaleDateString()"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </template>
</div>
{% endblock %}
